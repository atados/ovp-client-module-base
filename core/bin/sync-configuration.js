const legacyGlob = require('glob')
const chalk = require('chalk')
const path = require('path')
const fs = require('fs')
const compareVersions = require('compare-versions')
const { promisify } = require('util')

const stat = promisify(fs.stat)
const glob = promisify(legacyGlob)
const readFile = promisify(fs.readFile)
const writeFile = promisify(fs.writeFile)

async function main() {
  const matches = await glob(path.resolve('base', 'core', 'config', '{.,}**'))

  return Promise.all(
    matches.map(async filepath => {
      const filename = path.basename(filepath)
      const newFilePath = path.resolve(filename)
      const fileStat = await stat(filepath)
      let isAutoGeneratedFile = false

      if (fileStat.isDirectory()) {
        return
      }

      try {
        const targetPathStat = await stat(newFilePath)

        if (targetPathStat.isDirectory()) {
          console.error(
            `> Failed to create '${chalk.cyan(
              filename,
            )}'. It already exists as a directory`,
          )
          return
        } else {
          const fileContent = await readFile(newFilePath, 'utf8')

          fileContent.split('\n').some(line => {
            const isComment = line.trim().startsWith('//')
            if (isComment && line.includes('@channel:update')) {
              isAutoGeneratedFile = true
              return true
            }

            return !isComment
          })

          if (filename === 'package.json') {
            try {
              // Parse the current package.json version and the new package.json version
              // If the new version is greater than the current one, write the channel package.json
              // If the current version is greater than the current one, write the base package.json
              // If they are equal we can continue
              const channelPkg = JSON.parse(fileContent)
              const baseFileContent = await readFile(filepath, 'utf8')
              const basePkg = JSON.parse(baseFileContent)

              const comparison = compareVersions(
                basePkg.version,
                channelPkg.version,
              )

              if (comparison === 1) {
                console.log(
                  `> Atualizando ${chalk.cyan(path.join('package.json'))}`,
                )
                return writeFile(path.resolve('package.json'), baseFileContent)
              } else if (comparison === -1) {
                console.log(
                  `> Atualizando ${chalk.cyan(
                    path.join('base', 'core', 'config', 'package.json'),
                  )}`,
                )
                return writeFile(
                  path.resolve('base', 'core', 'config', 'package.json'),
                  fileContent,
                )
              } else {
                return console.log(
                  chalk.gray(
                    `> Pulando ${chalk.cyan(
                      'package.json',
                    )} porque a versão é igual a da base (${
                      channelPkg.version
                    })`,
                  ),
                )
              }
            } catch (error) {
              console.error(chalk.red(`> Failed to update package.json`))
              console.error(error)
            }
          }

          if (!isAutoGeneratedFile) {
            console.log(
              chalk.gray(
                `> Pulando ${chalk.cyan(filename)} já que o arquivo já existe`,
              ),
            )
            // Skip since the we shouldn't override the current content
            return
          }
        }
      } catch (error) {
        // File doesn't exist yet. Continue
      }

      if (filepath.endsWith('.js')) {
        console.log(
          `> ${isAutoGeneratedFile ? 'Atualizando' : 'Criando'} ${chalk.cyan(
            filename,
          )}`,
        )
        writeFile(
          newFilePath,
          `// Este arquivo é criado automaticamente.\n` +
            `// Remova a linha seguinte caso queira controlá-lo manualmente.\n` +
            `// @channel:update\n` +
            `module.exports = require('./${path.join(
              'base',
              'core',
              'config',
              path.basename(filename, path.extname(filename)),
            )}')\n`,
          'utf8',
        )
      } else {
        console.log(`> Copying ${chalk.cyan(filename)}`)
        fs.copyFileSync(filepath, newFilePath)
      }
    }),
  )
}

main()
